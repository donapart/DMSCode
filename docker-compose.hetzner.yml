# DMSCode Hetzner deployment
# - Exposes only nginx on 80
# - Services stay on the internal docker network
# - Configure env via .env.hetzner (see .env.hetzner.example)

services:
  nginx:
    image: nginx:alpine
    container_name: dmscode-nginx
    ports:
      - "80:80"
    environment:
      - DMS_SERVER_NAME=${DMS_SERVER_NAME}
      - DMS_API_KEY=${DMS_API_KEY}
    volumes:
      - ./docker/nginx.hetzner.conf.template:/etc/nginx/templates/default.conf.template:ro
    depends_on:
      - ocr-service
      - search-service
      - tts-service
      - ollama
    restart: unless-stopped

  ocr-service:
    image: python:3.11-slim
    container_name: dmscode-ocr
    volumes:
      - ./backend/ocr:/app
      - dmscode-temp:/tmp/ocr
    working_dir: /app
    command: >
      bash -c "pip install fastapi uvicorn pytesseract pdf2image Pillow &&
               apt-get update && apt-get install -y tesseract-ocr tesseract-ocr-deu poppler-utils &&
               uvicorn main:app --host 0.0.0.0 --port 8510"
    environment:
      - TESSDATA_PREFIX=/usr/share/tesseract-ocr/5/tessdata
    restart: unless-stopped

  search-service:
    image: python:3.11-slim
    container_name: dmscode-search
    volumes:
      - ./backend/search:/app
      - dmscode-embeddings:/data/embeddings
    working_dir: /app
    command: >
      bash -c "pip install fastapi uvicorn sentence-transformers chromadb &&
               uvicorn main:app --host 0.0.0.0 --port 8520"
    environment:
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2}
      - CHROMADB_PATH=/data/embeddings
    restart: unless-stopped

  ollama:
    image: ollama/ollama
    container_name: dmscode-ollama
    volumes:
      - dmscode-ollama:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    restart: unless-stopped

  tts-service:
    image: python:3.11-slim
    container_name: dmscode-tts
    volumes:
      - ./backend/tts:/app
      - dmscode-tts-models:/models
    working_dir: /app
    command: >
      bash -c "pip install fastapi uvicorn piper-tts &&
               uvicorn main:app --host 0.0.0.0 --port 8505"
    environment:
      - PIPER_MODELS_PATH=/models
      - DEFAULT_VOICE=${DEFAULT_VOICE:-de_DE-thorsten-low}
    restart: unless-stopped

  redis:
    image: redis:alpine
    container_name: dmscode-redis
    volumes:
      - dmscode-redis:/data
    restart: unless-stopped

  surrealdb:
    image: surrealdb/surrealdb:latest
    container_name: dmscode-surrealdb
    volumes:
      - dmscode-surrealdb:/data
    command: start --log trace --user root --pass root file:/data/database.db
    restart: unless-stopped

  graph-service:
    build:
      context: ./backend/graph
      dockerfile: Dockerfile
    container_name: dmscode-graph
    volumes:
      - ./backend/graph:/app
    environment:
      - LLM_PROVIDER=${LLM_PROVIDER:-ollama}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-3-haiku-20240307}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OLLAMA_URL=http://ollama:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-llama3.2:3b}
      - SURREALDB_URL=ws://surrealdb:8000/rpc
      - SURREALDB_NS=dmscode
      - SURREALDB_DB=knowledge
      - SURREALDB_USER=root
      - SURREALDB_PASS=root
    depends_on:
      - surrealdb
    restart: unless-stopped

  minio:
    image: minio/minio
    container_name: dmscode-minio
    command: server /data --console-address ":9001"
    volumes:
      - /mnt/dms_data/storage:/data
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-dmscode}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-dmscode123}
    ports:
      # Expose API (9000) and Console (9001) only to localhost or via VPN/Proxy
      - "127.0.0.1:9000:9000"
      - "127.0.0.1:9001:9001"
    restart: unless-stopped

  automation-service:
    build:
      context: ./backend/automation
      dockerfile: Dockerfile
    container_name: dmscode-automation
    volumes:
      - ./backend/automation:/app
    environment:
      - REDIS_URL=redis://redis:6379/0
      - LLM_PROVIDER=${LLM_PROVIDER:-ollama}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-3-haiku-20240307}
      - OLLAMA_URL=http://ollama:11434
      - GRAPH_SERVICE_URL=http://graph-service:8530
    depends_on:
      - redis
      - graph-service
    restart: unless-stopped

  storage-service:
    build:
      context: ./backend/storage
      dockerfile: Dockerfile
    container_name: dmscode-storage
    environment:
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-dmscode}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-dmscode123}
      - MINIO_SECURE=false
      - DEFAULT_BUCKET=documents
    depends_on:
      - minio
    restart: unless-stopped

  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: dmscode-web
    environment:
      - OCR_SERVICE_URL=http://ocr-service:8510
      - SEARCH_SERVICE_URL=http://search-service:8520
      - GRAPH_SERVICE_URL=http://graph-service:8530
      - AUTOMATION_SERVICE_URL=http://automation-service:8540
      - STORAGE_SERVICE_URL=http://storage-service:8550
    depends_on:
      - storage-service
      - search-service
    restart: unless-stopped

volumes:
  dmscode-temp:
  dmscode-embeddings:
  dmscode-ollama:
  dmscode-tts-models:
  dmscode-redis:
  dmscode-surrealdb:
  dmscode-minio:

networks:
  default:
    name: dmscode-network
